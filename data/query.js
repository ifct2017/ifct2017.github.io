(()=>{var m="https://ifct2017.deno.dev";var B="https://cdn.jsdelivr.net/npm/@ifct2017/pictures/assets/";var x=new Set(["code","name","scie","lang","grup","regn","tags"]),T=ifct2017.columns,_e=ifct2017.hierarchy,A=ifct2017.intakes,E=ifct2017.methods,Te=ifct2017.nutrients,d=ifct2017.representations,M=["whorda","usear","usrdam","usrdaf","euprim","euprif"],R=["ulus","uleu","uljapan"],I=new Map([["whorda","WHO Recommended Dietary Allowance"],["usear","US Estimated Average Requirement"],["usrdam","US Recommended Dietary Allowance (Male)"],["usrdaf","US Recommended Dietary Allowance (Female)"],["euprim","EU Population Reference Intake (Male)"],["euprif","EU Population Reference Intake (Female)"],["ulus","Tolerable intake Upper Level (US)"],["uleu","Tolerable intake Upper Level (EU)"],["uljapan","Tolerable intake Upper Level (Japan)"]]),X=new Map([["abbr","Abbreviation"],["desc","Description"],["kj","kJ"],["kcal","kcal"]]),Y=new Map([[1,"g"],[1e3,"mg"],[1e6,"ug"],[1e9,"ng"]]);function p(e){return Math.round(e*1e6)/1e6}function Z(e){var t=[];for(var n of e)t.indexOf(n)<0&&t.push(n);return t}function v(e){for(var t of e)return t}function N(n){var t={},n=n.startsWith("?")?n.substring(1):n;for(var r of n.split("&")){var o=r.split("=");t[decodeURIComponent(o[0])]=decodeURIComponent(o[1]||"")}return t}function y(e){return location.href=location.origin+e+location.hash}function U(e){return new Promise(function(t,n){$.getJSON(e,t).fail(n)})}function b(e,t,n,a,l){var a=a||4,l=l||1e3;return $.getJSON(e,t).fail(function(i){if(!a||i.responseJSON)return n(i);setTimeout(function(){b(e,t,n,a-1,l*2)},l)})}function h(e){return e.indexOf('"')>=0?e.replace(/\"(.*?)\"/g,function(t,n){return h(n)}):T.has(e)?T.get(e).name:X.get(e)||e[0].toUpperCase()+e.substring(1)}function O(e){return d.has(e)?d.get(e).type:null}function w(e){return d.has(e)?d.get(e).factor:1}function C(e){return d.has(e)?d.get(e).unit:null}function L(e){e=e.replace(/\[.*?\]/g,"").replace(/\s*\.?$/,""),e=e.replace(/\w+\.\s([\w\',\/\(\)\- ]+)[;\.]?/g,"$1, ");var t=e.split(/,\s*/g);return t[t.length-1]||t.pop(),Z(t).join(", ")}function S(e){return B+e+".jpeg"}function P(e,t){if(e!=="mass")return 1;var n=Math.log(t)/Math.log(1e3),r=-3*Math.round(n-.33);return Math.pow(10,Math.max(r,0))}function q(e,t){return e!=="mass"?"kJ":Y.get(t)}function W(e){var t=[];for(var n in e)n.endsWith("_e")||n.endsWith("_t")||x.has(n)||t.push(n);return t}function H(e,t){var n=[];for(var r of e)n.push(r[t]);return n}function F(e,t,n){var r=[];for(var o of e)r.push([o[t],o[n]]);return r}function j(e,t,n){var r=[],o=n+"_e";for(var a of e)r.push([a[t],a[n]-(a[o]||0),a[n]+(a[o]||0)]);return r}function D(e){var t=[];for(var n of e){var r={};for(var o in n)r[o.replace(/\W/g,"_")]=n[o];t.push(r)}return t}function Q(e){var t=[],n=e.length;for(var r of e)t.push(Object.assign({},r));for(var o in e[0]||{})if(!o.endsWith("_e"))for(var a=C(o),l=w(o),i=o+"_e",u=o+"_t",s=0;s<n;s++){var _=e[s][o],G=e[s][i]||0;a==null?t[s][u]=_:t[s][u]=p(_*l)+a+" \xB1 "+p(G*l)}return t}function J(){console.log("setupForms()");for(var e=document.querySelectorAll("form [type=submit]"),t=0,n=e.length;t<n;t++)e[t].onclick=function(){this.form.submitted=this.name}}function K(){console.log("setupFooter()");var e=document.querySelector("footer");e.offsetTop+e.offsetHeight<e.innerHeight&&(e.style.bottom="0",e.style.position="absolute"),e.style.display="block"}function g(){$(this).text()||$(this).triggerHandler(jQuery.Event("keyup",{keyCode:65,which:65}))}function z(e=!1){console.log("setupQueryAutocomplete()"),$("#text").on("keydown",function(t){t.keyCode===13&&(t.preventDefault(),$("form").submit())}),$("#text").easyAutocomplete({url:function(t){return m+"/api/query/search?text="+encodeURIComponent(t)},getValue:function(t){return t.text},list:{onClickEvent:function(){$("form").submit()}}}).click(g).change(g),e&&g.call(document.querySelector("#text"))}var k=["rgba(200,255,200,0.5)","rgba(255,200,200,0.5)"],c=null,f=null;function ee(){c!=null&&(c.destroy(),$("#table").empty(),c=null)}function te(e){var t=[{class:"details-control",orderable:!1,data:null,defaultContent:""}];t.push({title:h("name"),data:{_:"name_t",sort:"name"}});for(var n in e[0]||{})if(!(n.endsWith("_e")||n.endsWith("_t")||x.has(n))){var r=n.replace(/\W/g,"_");t.push({title:h(n),data:{_:r+"_t",sort:r}})}return t}function ne(e){for(var t of e)t.name_t='<a href="/data/compositions?code='+t.code+'">'+t.name+"</a>";return e}function re(e){var t=document.getElementById("table_child").innerHTML;return t=t.replace("${code}",e.code),t=t.replace("${picture}",'src="'+S(e.code)+'"'),t=t.replace("${name}",e.name),t=t.replace("${scie}",e.scie),t=t.replace("${grup}",e.grup),t=t.replace("${lang}",L(e.lang)),t=t.replace("${quantities}",""),t}function oe(){var e=$(this).closest("tr"),t=c.row(e),n=$.inArray(e.attr("id"),c.children);t.child.isShown()?(e.removeClass("details"),t.child.hide(),c.children.splice(n,1)):(e.addClass("details"),t.child(re(t.data())).show(),n===-1&&c.children.push(e.attr("id")))}function ae(){for(var e of c.children||[])$("#"+e+" td.details-control").trigger("click")}function ie(e){if(ee(),e.length!==0){var t=te(e);e=D(e);var n=ne(e);c=$("#table").DataTable({columns:t,data:n,aaSorting:[],scrollX:!0,autoWidth:!0,retrieve:!0,fixedHeader:{header:!0,footer:!0}}),c.children=[],c.on("draw",ae),$("#table tbody").on("click","tr td.details-control",oe),$("#table_length > label").append($("#table_expandt").html()),$("#table_expand").click(function(){c.rows(":not(.parent)").nodes().to$().find("td:first-child").trigger("click")}),setTimeout(function(){window.dispatchEvent(new Event("resize"))},0)}}function le(){f!=null&&(f.destroy(),$("#chart").empty(),f=null)}function ue(e,t,n){for(var r=[],o=Highcharts.getOptions().colors,a=0,l=n.length;a<l;a++){var i=n[a],u=e[0][i+"_e"]!=null;r.push({name:h(i),data:F(e,t,i),zIndex:2*a+1,_code:i,marker:{fillColor:"white",lineWidth:2,lineColor:o[a]},_type:O(i)}),u&&r.push({name:"Range",data:j(e,t,i),type:"arearange",lineWidth:0,linkedTo:":previous",color:o[a],fillOpacity:.3,zIndex:2*a,marker:{enabled:!1}})}return r}function se(e){var t="";for(var n of e)t+=h(n)+", ";return t.length?(t=t.substring(0,t.length-2),t+=" per 100g",t):null}function ce(e){if(e.size!==1)return null;var t=E.get(v(e));return t==null?null:t.method+"; "+t.reference}function V(e,t){var n=[],r=A.get(e);if(r==null)return n;for(var o=0;o<2;o++){var a=[],l=[],i=o===0?M:R;for(var u of i)if(r[u]!=null){var s=(r[u]<0?-70:1)*r[u];a.push({point:{xAxis:0,yAxis:0,x:t-1,y:s},text:I.get(u)}),l.push({type:"path",points:[{xAxis:0,yAxis:0,x:0,y:s},{xAxis:0,yAxis:0,x:t-1,y:s}]})}a.length>0&&n.push({id:o,labels:a,shapes:l,labelOptions:{backgroundColor:k[o],y:5,borderColor:"none"}})}return n}function pe(e,t){for(var n=0,r=(e.annotations||[]).length;n<r;n++)e.removeAnnotation(n);if(!(t.size!==1||!e.rows))for(var o of V(v(t),e.rows.length))e.addAnnotation(o)}function fe(){this.yAxis.userOptions._ready=!1}function de(e){var t=this.name,n=f.rows;console.log("chartPointClick() name:",t);for(var r=0,o=n.length;r<o;r++)if(n[r].name===t){var a=n[r].code;y("/data/compositions?code="+a)}}function he(e){var t=e.series,n=new Set,r=new Set;for(var o of t)!o.visible||o.name==="Range"||(n.add(o.userOptions._type),r.add(o.userOptions._code));var a=n.size===1?v(n):null,l=P(a,e.max),i=q(a,l);return Object.assign(e.userOptions,{_codes:r,_type:a,_factor:l,_unit:i}),{type:a,factor:l,unit:i,codes:r}}function me(){var e=this.axis.userOptions;e._ready||(he(this.axis),e._ready=!0,this.chart.setTitle({text:se(e._codes)}),this.chart.setSubtitle({text:ce(e._codes)}),pe(this.chart,e._codes));var t=e._type,n=e._factor,r=e._unit;return t?p(this.value*n)+r:this.value}function ve(e){for(var t="",n=0,r=e.length;n<r;n++){var o=e[n],a=e[n+1];if(o.colorIndex!=null){var l=a&&a.colorIndex==null,i=o.series.userOptions._code,u=w(i),s=C(i);t+="<tr><th>"+o.series.name+"</th>",t+="<td>"+p(o.y*u)+(s||""),l&&(t+=" ("+p(a.point.high*u)+" - "+p(a.point.low*u)+")"),t+=`</td></tr>
`}}return t}function ge(){var e=f.rows[this.x],t=document.getElementById("chart-tooltip").innerHTML,n=t.replace("${picture}",'src="'+S(e.code)+'"');return n=n.replace("${name}",e.name),n=n.replace("${scie}",e.scie?"("+e.scie+")":""),n=n.replace("${grup}",e.grup),n=n.replace("${quantities}","<table>"+ve(this.points)+"</table>"),n}function xe(e,t,n){le();var r=H(e,t),o=ue(e,t,n),a=V(n.length===1?n[0]:null,e.length);f=Highcharts.chart("chart",{chart:{style:{fontFamily:'"Righteous", cursive'}},title:{text:null},legend:{},xAxis:{labels:{enabled:!0,formatter:function(){return r[Math.round(this.value)]}}},yAxis:{title:{text:null},labels:{formatter:me}},annotations:a,tooltip:{crosshairs:!0,shared:!0,useHTML:!0,formatter:ge},series:o,plotOptions:{series:{events:{legendItemClick:fe},point:{events:{click:de}}}}}),f.rows=e}function ye(e){console.log("processQuery()",e),b(m+"/api/english?text="+encodeURIComponent(e),function(t){console.log("Slang:",t.slang),console.log("SQL:",t.sql);var n=t.rows,r=t.meta;if(n.length!==0){n=Q(n);var o=W(n[0]||{});ie(n,r),o.length>0&&xe(n,"name",o),be(e)}},function(t){var n=t.responseJSON;console.log("processQuery().fail",n),iziToast.error({title:n.message,message:"<b>SLANG:</b> "+n.slang+"<br><b>SQL:</b> "+n.sql,timeout:2e4})}).fail(function(t){t.responseJSON||iziToast.warning({title:"Server offline",message:"Server will come up in 5s!",timeout:2e4})})}async function be(e){var t=await U(m+"/api/query/save?text="+encodeURIComponent(e));console.log("Query saved: "+t[0].text+" ["+t[0].score+"]")}function we(e){var t=e.target.submitted;console.log("onSubmit()",t);var n=document.getElementById("text").value;return y("/data/query?text="+n),!1}function Ce(){var e=location.search;if(console.log("setupLocation()",e),e.length!==0){var t=N(e);if(t.text){var n=document.getElementById("text");n.value=t.text,ye(t.text)}}}function Se(){console.log("setup()"),$("form").submit(we),J(),K(),Ce(),z()}$(document).ready(Se);})();
