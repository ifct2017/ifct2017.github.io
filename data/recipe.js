(()=>{var h="https://ifct2017.deno.dev";var v=new Set(["code","name","scie","lang","grup","regn","tags"]),m=ifct2017.columns,H=ifct2017.hierarchy,J=ifct2017.intakes,z=ifct2017.methods,D=ifct2017.nutrients,d=ifct2017.representations;var A=new Map([["abbr","Abbreviation"],["desc","Description"],["kj","kJ"],["kcal","kcal"]]);function x(e){return Math.round(e*1e6)/1e6}function b(e){return e.indexOf('"')>=0?e.replace(/\"(.*?)\"/g,function(t,n){return b(n)}):m.has(e)?m.get(e).name:A.get(e)||e[0].toUpperCase()+e.substring(1)}function _(e){var t="",n=null;if(e.indexOf('"')<0)return m.has(e)?m.get(e).tags:e;for(;(n=/\"(.*?)\"/g.exec())!=null;)t+=_(n[1])+" ";return t.substring(0,t.length-1)}function N(e){return d.has(e)?d.get(e).factor:1}function U(e){return d.has(e)?d.get(e).unit:null}function C(e){var t=[],n=e.length;for(var r of e)t.push(Object.assign({},r));for(var o in e[0]||{})if(!o.endsWith("_e"))for(var c=U(o),i=N(o),a=o+"_e",u=o+"_t",l=0;l<n;l++){var s=e[l][o],p=e[l][a]||0;c==null?t[l][u]=s:t[l][u]=x(s*i)+c+" \xB1 "+x(p*i)}return t}var P=[{title:"Nutrient"},{title:"Value"}];function T(e,t,n,r,o){var c=ifct2017.columns,i=ifct2017.hierarchy,a=document.createElement("tr"),u=n+"_e",l=n+"_t";n!=="water"&&(a.style.backgroundColor=`rgb(80, 255, 80, ${Math.max(o[n],0)})`),a.setAttribute("data-tt-id",n),r&&a.setAttribute("data-tt-parent-id",r);var s=document.createElement("td");s.setAttribute("data-search",b(n)+" "+_(n)||""),s.textContent=(c.get(n)||{}).name;var p=document.createElement("a");p.setAttribute("href","javascript:void(0);"),p.innerHTML="&nbsp; \u2139\uFE0F",s.appendChild(p),a.appendChild(s),s=document.createElement("td"),s.setAttribute("data-order",t[n]),s.textContent=t[l],a.appendChild(s),e.appendChild(a);var y=(i.get(n)||{}).children||"";if(y)for(var R of y.split(" "))T(e,t,R,n,o)}function w(e,t,n,r,o){return console.log("setupCompositionTable()"),t=$(e).DataTable({columns:P,aaSorting:[],pageLength:1e3}),t.on("order.dt",function(){$(e).treetable("expandAll")}),t.on("search.dt",function(){t.search()?$(e).treetable("expandAll"):$(e).treetable("collapseAll")}),setTimeout(function(){window.dispatchEvent(new Event("resize"))},0),t}function E(e,t,n){console.log("setupCompositionTreetable()");var r=ifct2017.hierarchy,o=document.createDocumentFragment();for(var c in t)if(!(c.endsWith("_e")||c.endsWith("_t")||v.has(c))){var i=(r.get(c)||{}).parents||"";i||T(o,t,c,null,n)}var a=document.createElement("tbody");a.appendChild(o),document.querySelector(e).innerHTML="",document.querySelector(e).appendChild(a),$(e).treetable({expandable:!0,clickableNodeNames:!0})}var f=null,O=0,S=new Map;function M(e){console.log(`addIngredient(${e})`),function(t){var n=`<a href="javascript:void(0)" id="remove_${t}">Remove this</a>`,r=`<input type="hidden" id="code_${t}" name="code_${t}" value=""/>`,o=`<label for="name_${t}">Ingredient name [${n}]</label>`,c=`<input type="text" id="name_${t}" name="ingredient_${t}" placeholder="E.g., 'Lentil whole, brown'"/>`,i=`<label for="quantity_${t}">Quantity (in grams)</label>`,a=`<input type="text" id="quantity_${t}" name="quantity_${t}" placeholder="E.g., 500"/>`,u=`<label for="yield_${t}">Yield factor (0.0 to 1.0)</label>`,l=`<input type="text" id="yield_${t}" name="yield_${t}" placeholder="E.g., 0.8"/>`;$(e).append(`<div id="ingredient_${t}" col="1">${r}${o}${c}<grid><div col="1/2">${i}${a}</div><div col="1/2">${u}${l}</div></grid></div>`),$(`#name_${t}`).change(function(){L(t)}),$(`#quantity_${t}`).change(function(){g()}),$(`#yield_${t}`).change(function(){g()}),$(`#remove_${t}`).click(function(){q(t)})}(++O)}async function L(e){console.log(`updateIngredientName(${e})`);var t=$(`#name_${e}`).val().trim()||"";if(!t)return;var n=await new Promise(function(i,a){$.getJSON(h+"/api/descriptions?text="+t,i).fail(function(u,l,s){console.error("Error fetching ingredient name:",s),a(s)})});if(n.length===0){$(`#code_${e}`).val(""),$(`#name_${e}`).attr("style","background-color: #ffcccc;"),iziToast.error({title:"Error",message:`No ingredient found for "${t}"`});return}if(n.length===1){var r=n[0];$(`#code_${e}`).val(r.code),$(`#name_${e}`).val(r.name),$(`#name_${e}`).attr("style",""),iziToast.success({title:"Success",message:`Ingredient "${r.name}" found`});return}var o=[];function c(i){return[`<button id="choose_${i.code}">${i.name}</button>`,function(a,u){a.hide({transitionOut:"fadeOut"},u,i.code)}]}for(var r of n)o.push(c(r));o.length&&o[0].push(!0),iziToast.show({title:"Multiple ingredients found",message:"Please select one of the ingredients from the list",position:"topCenter",buttons:o,timeout:!1,onClosing:function(i,a,u){if(u){var l=u,s=n.find(p=>p.code===l);$(`#code_${e}`).val(l),$(`#name_${e}`).val(s.name),$(`#name_${e}`).attr("style",""),iziToast.success({title:"Success",message:`Ingredient '${s.name}' selected`})}else $(`#code_${e}`).val(""),$(`#name_${e}`).attr("style","background-color: #ffcccc;"),iziToast.error({title:"Error",message:"No ingredient selected"})}})}function q(e){console.log(`removeIngredient(${e})`);var t=$(`#name_${e}`).val()||"unknown";$(`#ingredient_${e}`).remove(),g(),iziToast.success({title:"Success",message:`Removed ingredient ${t}`})}function I(e){console.log(`getIngredients(${e})`);for(var t=[],n=$(e).children("div"),r=0;r<n.length;++r){var o=n[r].id.split("_")[1],c=$(`#code_${o}`).val()||"",i=$(`#name_${o}`).val()||"",a=parseFloat($(`#quantity_${o}`).val())||0,u=parseFloat($(`#yield_${o}`).val())||1;!c||!i||!a||!u||t.push({code:c,name:i,quantity:a,yield:u})}return t}function j(e,t){console.log("loadIngredientCompositions(...)");var n=[];for(var r of e){var o=r.code;if(!t.has(o)){var c=new Promise(function(i,a){$.getJSON(h+"/api/data?table=compositions&code="+o,function(u){t.set(o,u[0]),i(u[0])}).fail(function(u,l,s){a(s)})});n.push(c)}}return Promise.all(n)}function F(e,t){console.log("computeRecipeComposition(...)");var n=Object.assign({},t.get(e[0].code));for(var r in n)v.has(r)||(n[r]=0);for(var o of e){var c=o.code,i=o.quantity||0,a=o.yield||1,u=t.get(c);for(var r in n)if(!v.has(r)){var l=u[r]||0;n[r]+=l*(i/100)*a}}return n}async function g(){console.log("updateCompositionTable()");var e=I("#ingredients");if(e.length===0){$("#composition_parent").attr("style","display: none;");return}$("#composition_parent").removeAttr("style"),await j(e,S);var t=F(e,S);f&&(f.destroy(!0),$("#composition").remove(),$("#composition_wrapper").remove(),$("#composition_parent").append('<table id="composition" class="hover stripe order-column"></table>'),f=null),E("#composition",C([t])[0]),f=w("#composition",f)}function W(){console.log("onReady()"),$("#ingredients_add").click(function(){M("#ingredients")}),$("#ingredients").removeAttr("style"),M("#ingredients")}$(document).ready(W);})();
