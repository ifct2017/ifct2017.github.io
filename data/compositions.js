(()=>{var m="https://ifct2017.deno.dev";var I="https://cdn.jsdelivr.net/npm/@ifct2017/pictures/assets/";var L=new Set(["code","name","scie","lang","grup","regn","tags"]),p=ifct2017.columns,G=ifct2017.hierarchy,K=ifct2017.intakes,Q=ifct2017.methods,X=ifct2017.nutrients,f=ifct2017.representations;var j=new Map([["abbr","Abbreviation"],["desc","Description"],["kj","kJ"],["kcal","kcal"]]);function y(e){return Math.round(e*1e6)/1e6}function O(e){var t=[];for(var n of e)t.indexOf(n)<0&&t.push(n);return t}function b(n){var t={},n=n.startsWith("?")?n.substring(1):n;for(var a of n.split("&")){var o=a.split("=");t[decodeURIComponent(o[0])]=decodeURIComponent(o[1]||"")}return t}function h(e){return new Promise(function(t,n){$.getJSON(e,t).fail(n)})}function C(e){return new Promise((t,n)=>{Papa.parse(e,{download:!0,header:!0,worker:!0,dynamicTyping:!0,complete:t,error:n})})}function v(e){return e.indexOf('"')>=0?e.replace(/\"(.*?)\"/g,function(t,n){return v(n)}):p.has(e)?p.get(e).name:j.get(e)||e[0].toUpperCase()+e.substring(1)}function w(e){var t="",n=null;if(e.indexOf('"')<0)return p.has(e)?p.get(e).tags:e;for(;(n=/\"(.*?)\"/g.exec())!=null;)t+=w(n[1])+" ";return t.substring(0,t.length-1)}function q(e){return f.has(e)?f.get(e).factor:1}function W(e){return f.has(e)?f.get(e).unit:null}function S(e){e=e.replace(/\[.*?\]/g,"").replace(/\s*\.?$/,""),e=e.replace(/\w+\.\s([\w\',\/\(\)\- ]+)[;\.]?/g,"$1, ");var t=e.split(/,\s*/g);return t[t.length-1]||t.pop(),O(t).join(", ")}function E(e){return I+e+".jpeg"}function T(e){var t=[],n=e.length;for(var a of e)t.push(Object.assign({},a));for(var o in e[0]||{})if(!o.endsWith("_e"))for(var r=W(o),u=q(o),i=o+"_e",d=o+"_t",c=0;c<n;c++){var s=e[c][o],l=e[c][i]||0;r==null?t[c][d]=s:t[c][d]=y(s*u)+r+" \xB1 "+y(l*u)}return t}var D=[{title:"Nutrient"},{title:"Value"}];function M(e,t){var n=[];for(var a in t)typeof t[a]!="number"||a.endsWith("_e")||a!=="water"&&n.push({name:a,value:t[a]});n.sort(function(u,i){return i.value-u.value}),n=n.slice(0,10);var o='<h4 txt="c">Insights</h4>';o+="<table>",o+=`<caption><strong>${t.name} is a good source of:</strong></caption>`,o+='<thead><tr><th scope="col">Nutrient</th><th scope="col">Value</th></tr></thead>',o+="<tbody>";for(var r of n)o+=`<tr data-tt-id="${r.name}"><td>${v(r.name)}<a href="javascript:void(0);">&nbsp; \u2139\uFE0F</a></td><td>${Math.round(r.value*100)}% <a href="javascript:void(0);">\u2B06\uFE0F</a></td></tr>`;o+="</tbody>",$(e).html(o)}function A(e,t,n,a,o){var r=ifct2017.columns,u=ifct2017.hierarchy,i=document.createElement("tr"),d=n+"_e",c=n+"_t";n!=="water"&&(i.style.backgroundColor=`rgb(80, 255, 80, ${Math.max(o[n],0)})`),i.setAttribute("data-tt-id",n),a&&i.setAttribute("data-tt-parent-id",a);var s=document.createElement("td");s.setAttribute("data-search",v(n)+" "+w(n)||""),s.textContent=(r.get(n)||{}).name;var l=document.createElement("a");l.setAttribute("href","javascript:void(0);"),l.innerHTML="&nbsp; \u2139\uFE0F",s.appendChild(l),i.appendChild(s),s=document.createElement("td"),s.setAttribute("data-order",t[n]),s.textContent=t[c],i.appendChild(s),e.appendChild(i);var x=(u.get(n)||{}).children||"";if(x)for(var N of x.split(" "))A(e,t,N,n,o)}function U(e,t,n,a,o){return console.log("setupCompositionTable()"),t=$(e).DataTable({columns:D,aaSorting:[],pageLength:1e3}),t.on("order.dt",function(){$(e).treetable("expandAll")}),t.on("search.dt",function(){t.search()?$(e).treetable("expandAll"):$(e).treetable("collapseAll")}),setTimeout(function(){window.dispatchEvent(new Event("resize"))},0),t}function P(e,t,n){console.log("setupCompositionTreetable()");var a=ifct2017.hierarchy,o=document.createDocumentFragment();for(var r in t)if(!(r.endsWith("_e")||r.endsWith("_t")||L.has(r))){var u=(a.get(r)||{}).parents||"";u||A(o,t,r,null,n)}var i=document.createElement("tbody");i.appendChild(o),document.querySelector(e).innerHTML="",document.querySelector(e).appendChild(i),$(e).treetable({expandable:!0,clickableNodeNames:!0})}var R=null,g=new Map,F="https://jsr.io/@nodef/ifct2017/1.3.6/columndescriptions/index.csv";async function H(){var e=b(location.search),t=e.code||"A001",n=await h(m+"/api/data?table=compositions&code="+t),a=await h(m+"/api/insights?table=compositions&code="+t);M("#insights",a);var o=T(n),r=o[0]||{};$("#composition_caption").attr("style",""),$("#picture").attr("src",E(r.code)),$("#name").html(r.name+(r.scie?' <small style="font-style: italic;">('+r.scie+")</small>":"")),$("#grup").text(r.grup),$("#lang").text(S(r.lang)),P("#composition",r,a),R=U("#composition",R),$("#info").removeAttr("style")}function _(e,t="auto"){console.log("setupCompositionPopovers(): Setting up popovers ...");for(var n of document.querySelectorAll(`${e} tbody tr`)){var a=n.getAttribute("data-tt-id");if(g.has(a)){var o=g.get(a);new bootstrap.Popover(n.querySelector('td a[href="javascript:void(0);"]'),{trigger:"hover focus",html:!0,placement:t,title:o.name,content:`<p>${o.shortdesc}</p><p>${o.longdesc}</p>`}),e==="#insights"&&new bootstrap.Popover(n.querySelector('td:last-of-type a[href="javascript:void(0);"]'),{trigger:"hover focus",html:!0,placement:t,content:"<p>0% - 100% indicates average to maximum values of the nutrient content</p>"})}}console.log("setupCompositionPopovers(): Popovers set up")}async function J(){var e=await C(F);for(var t of e.data)g.set(t.code,t);console.log("fetchColumnDescriptions(): Column descriptions loaded")}async function V(){var e=J(),t=new Promise(n=>{$(document).ready(()=>{n(H())})});await Promise.all([e,t]),_("#composition"),_("#insights","top")}V();})();
